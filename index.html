<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Deck Builder</title>

    <!-- CDN externes -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>
    <!-- Header -->
    <div class="header">
        <h1>üé¥ MTG Deck Builder</h1>
        <p>Cr√©ez et testez vos decks Magic The Gathering</p>
    </div>

    <!-- Application Vue.js -->
    <div id="app">
        <div class="container">
            <!-- Loading global -->
            <div v-if="loading" class="loading-overlay">
                <div class="spinner"></div>
                <p>Initialisation de l'application...</p>
            </div>

            <!-- 1. Configuration Supabase -->
            <div v-if="!loading && !supabaseConfigured" class="config-form">
                <h2>‚öôÔ∏è Configuration Supabase</h2>
                <div class="config-notice">
                    <strong>Configuration requise :</strong> Veuillez configurer votre projet Supabase pour commencer √†
                    utiliser l'application.
                </div>

                <div class="form-group">
                    <label for="supabase-url">URL du projet Supabase :</label>
                    <input type="url" id="supabase-url" v-model="supabaseConfig.url"
                        placeholder="https://votre-projet.supabase.co" />
                </div>
                <div class="form-group">
                    <label for="supabase-key">Cl√© publique (anon key) :</label>
                    <input type="text" id="supabase-key" v-model="supabaseConfig.anonKey"
                        placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." />
                </div>
                <button @click="configureSupabase" class="btn"
                    :disabled="authLoading || !supabaseConfig.url || !supabaseConfig.anonKey">
                    {{ authLoading ? 'Connexion en cours...' : 'Se connecter √† Supabase' }}
                </button>

                <!-- Instructions de configuration -->
                <div style="margin-top: 2rem;">
                    <h3>üìã Instructions de configuration :</h3>
                    <ol style="margin-left: 1.5rem; line-height: 1.8;">
                        <li>Cr√©ez un compte gratuit sur <a href="https://supabase.com" target="_blank"
                                rel="noopener">supabase.com</a></li>
                        <li>Cr√©ez un nouveau projet</li>
                        <li>Allez dans <strong>Settings ‚Üí API</strong></li>
                        <li>Copiez l'<strong>URL du projet</strong> et la <strong>cl√© "anon/public"</strong></li>
                        <li>Ex√©cutez ce script SQL dans l'onglet <strong>SQL Editor</strong> :</li>
                    </ol>
                    <div class="code-block">
                        CREATE TABLE decks (
                        id BIGSERIAL PRIMARY KEY,
                        user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
                        name TEXT NOT NULL,
                        cards JSONB DEFAULT '{}',
                        created_at TIMESTAMPTZ DEFAULT NOW(),
                        updated_at TIMESTAMPTZ DEFAULT NOW()
                        );

                        -- Activer RLS (Row Level Security)
                        ALTER TABLE decks ENABLE ROW LEVEL SECURITY;

                        -- Politique pour que les utilisateurs ne voient que leurs decks
                        CREATE POLICY "Users can view own decks" ON decks
                        FOR SELECT USING (auth.uid() = user_id);

                        CREATE POLICY "Users can insert own decks" ON decks
                        FOR INSERT WITH CHECK (auth.uid() = user_id);

                        CREATE POLICY "Users can update own decks" ON decks
                        FOR UPDATE USING (auth.uid() = user_id);

                        CREATE POLICY "Users can delete own decks" ON decks
                        FOR DELETE USING (auth.uid() = user_id);
                    </div>
                </div>
            </div>

            <!-- 2. Statut de connexion -->
            <div v-if="!loading && supabaseConfigured" class="connection-status"
                :class="{ connected: isConnected, disconnected: !isConnected }">
                {{ isConnected ? '‚úÖ Connect√© √† Supabase' : '‚ùå Connexion √† Supabase √©chou√©e' }}
            </div>

            <!-- 3. Authentification -->
            <div v-if="!loading && supabaseConfigured && !isAuthenticated" class="auth-container">
                <h2 style="text-align: center; margin-bottom: 1.5rem; color: var(--primary-color);">
                    üîê Authentification
                </h2>

                <div class="tab-buttons">
                    <button class="tab-button" :class="{ active: authMode === 'login' }" @click="authMode = 'login'">
                        Connexion
                    </button>
                    <button class="tab-button" :class="{ active: authMode === 'register' }"
                        @click="authMode = 'register'">
                        Inscription
                    </button>
                </div>

                <!-- Formulaire de connexion -->
                <form v-if="authMode === 'login'" @submit.prevent="login">
                    <div class="form-group">
                        <label for="email">Email :</label>
                        <input type="email" id="email" v-model="loginForm.email" required
                            placeholder="votre@email.com" />
                    </div>
                    <div class="form-group">
                        <label for="password">Mot de passe :</label>
                        <input type="password" id="password" v-model="loginForm.password" required
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                    </div>
                    <button type="submit" class="btn" :disabled="authLoading">
                        {{ authLoading ? 'Connexion...' : 'Se connecter' }}
                    </button>
                </form>

                <!-- Formulaire d'inscription -->
                <form v-if="authMode === 'register'" @submit.prevent="register">
                    <div class="form-group">
                        <label for="reg-email">Email :</label>
                        <input type="email" id="reg-email" v-model="registerForm.email" required
                            placeholder="votre@email.com" />
                    </div>
                    <div class="form-group">
                        <label for="reg-password">Mot de passe (minimum 6 caract√®res) :</label>
                        <input type="password" id="reg-password" v-model="registerForm.password" required
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6" />
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">Confirmer le mot de passe :</label>
                        <input type="password" id="confirm-password" v-model="registerForm.confirmPassword" required
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                    </div>
                    <button type="submit" class="btn" :disabled="authLoading">
                        {{ authLoading ? 'Inscription...' : 'S\'inscrire' }}
                    </button>
                </form>

                <!-- Messages d'erreur et de succ√®s -->
                <div v-if="authError" class="error">
                    {{ authError }}
                </div>
                <div v-if="authSuccess" class="success">
                    {{ authSuccess }}
                </div>
            </div>

            <!-- 4. Application principale -->
            <div v-if="!loading && supabaseConfigured && isAuthenticated" class="app-container">
                <!-- En-t√™te utilisateur -->
                <div class="user-info">
                    <div>
                        <strong>üëã Bienvenue, {{ currentUser?.email }} !</strong>
                        <div style="font-size: 0.9rem; color: var(--secondary-color); margin-top: 0.25rem;">
                            {{ userDecks.length }} deck{{ userDecks.length > 1 ? 's' : '' }} cr√©√©{{ userDecks.length > 1
                            ? 's' : '' }}
                        </div>
                    </div>
                    <div class="user-actions">
                        <button @click="exportDeck" v-if="currentDeck" class="btn btn-small" title="Exporter le deck">
                            üìÑ Exporter
                        </button>
                        <button @click="copyDeckToClipboard" v-if="currentDeck" class="btn btn-small"
                            title="Copier la liste">
                            üìã Copier
                        </button>
                        <button @click="logout" class="btn btn-secondary">D√©connexion</button>
                    </div>
                </div>

                <!-- Vue: Liste des decks -->
                <div v-if="currentView === 'decks'">
                    <div class="deck-header">
                        <div>
                            <h2>üìö Mes Decks</h2>
                            <div class="deck-quick-stats">
                                <span class="stat">{{ userDecks.length }} deck{{ userDecks.length > 1 ? 's' : ''
                                    }}</span>
                                <span class="stat" v-if="userDecks.length > 0">
                                    {{ userDecks.reduce((total, deck) => total + getTotalCardsFromDeckData(deck.cards),
                                    0) }} cartes au total
                                </span>
                            </div>
                        </div>
                        <div class="deck-actions">
                            <button @click="showCreateDeck = true" class="btn">
                                ‚ûï Nouveau Deck
                            </button>
                        </div>
                    </div>

                    <!-- Formulaire de cr√©ation de deck -->
                    <div v-if="showCreateDeck"
                        style="margin-bottom: 2rem; padding: 1.5rem; background: var(--light-color); border-radius: var(--border-radius); border: 2px solid var(--primary-color);">
                        <h3>‚ú® Cr√©er un nouveau deck</h3>
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label for="deck-name">Nom du deck :</label>
                            <input type="text" id="deck-name" v-model="newDeckName" placeholder="Mon super deck"
                                @keyup.enter="createDeck" maxlength="100" />
                        </div>
                        <div class="form-actions">
                            <button @click="createDeck" class="btn" :disabled="!newDeckName.trim() || deckLoading">
                                {{ deckLoading ? 'Cr√©ation...' : '‚ú® Cr√©er' }}
                            </button>
                            <button @click="showCreateDeck = false; newDeckName = ''" class="btn btn-secondary">
                                Annuler
                            </button>
                        </div>
                    </div>

                    <!-- Loading des decks -->
                    <div v-if="decksLoading" class="loading">
                        ‚è≥ Chargement des decks...
                    </div>

                    <!-- Liste des decks -->
                    <div v-if="!decksLoading" class="deck-list">
                        <div v-for="deck in userDecks" :key="deck.id" class="deck-card">
                            <div class="deck-info" @click="openDeck(deck)">
                                <h3>{{ deck.name }}</h3>
                                <div class="deck-quick-stats">
                                    <span class="stat">{{ getTotalCardsFromDeckData(deck.cards) }} cartes</span>
                                    <span class="stat">{{ formatRelativeDate(deck.updated_at || deck.created_at)
                                        }}</span>
                                </div>
                                <!-- Aper√ßu des couleurs du deck - TEMPORAIREMENT D√âSACTIV√â -->
                                <!-- 
                                <div class="color-identity" v-if="getDeckColorPreview(deck.cards).length > 0">
                                    <span 
                                        v-for="color in getDeckColorPreview(deck.cards)" 
                                        :key="color"
                                        class="color-symbol"
                                        :title="getColorName(color)"
                                    >
                                        {{ getColorSymbol(color) }}
                                    </span>
                                </div>
                                -->
                            </div>
                            <div class="deck-actions">
                                <button @click="duplicateDeck(deck)" class="btn btn-small" title="Dupliquer le deck">
                                    üìã
                                </button>
                                <button @click="openDeck(deck)" class="btn btn-small">
                                    Ouvrir
                                </button>
                            </div>
                        </div>

                        <!-- Message si aucun deck -->
                        <div v-if="userDecks.length === 0" class="empty-state">
                            <h3>üé¥ Aucun deck trouv√©</h3>
                            <p>Cr√©ez votre premier deck pour commencer √† construire votre collection !</p>
                            <button @click="showCreateDeck = true" class="btn">
                                ‚ú® Cr√©er mon premier deck
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Vue: √âditeur de deck -->
                <div v-if="currentView === 'deck-editor' && currentDeck">
                    <!-- En-t√™te du deck -->
                    <div class="deck-header">
                        <div>
                            <h2>‚ö° {{ currentDeck.name }}</h2>
                            <div class="deck-quick-stats">
                                <span class="stat">{{ getTotalCards() }} cartes</span>
                                <span class="stat">{{ getCreatureCount() }} cr√©atures</span>
                                <span class="stat">{{ getSpellCount() }} sorts</span>
                                <span class="stat">{{ getLandCount() }} terrains</span>
                            </div>
                        </div>
                        <div class="deck-actions">
                            <button @click="saveDeck" class="btn" :disabled="deckLoading">
                                {{ deckLoading ? 'Sauvegarde...' : 'üíæ Sauvegarder' }}
                            </button>
                            <button @click="goBackToDecks" class="btn btn-secondary">
                                ‚Üê Retour
                            </button>
                        </div>
                    </div>

                    <!-- √âditeur principal -->
                    <div class="deck-editor">
                        <!-- Panel de gauche: Recherche et ajout -->
                        <div class="editor-panel search-panel">
                            <h3>üîç Recherche de cartes</h3>

                            <!-- Recherche de cartes -->
                            <div class="card-search">
                                <div class="form-group">
                                    <input type="text" v-model="searchQuery" @input="searchCards"
                                        placeholder="Rechercher une carte Magic..." />
                                </div>

                                <div v-if="searchLoading" class="loading">
                                    üîç Recherche en cours...
                                </div>

                                <div v-if="searchResults.length > 0" class="search-results">
                                    <div v-for="card in searchResults" :key="card.id" class="card-result"
                                        @click="addCardToDeck(card)"
                                        :title="`Cliquer pour ajouter ${card.name} au deck`">
                                        <img :src="card.image_uris?.small || 'assets/images/placeholder.png'"
                                            :alt="card.name" class="card-image"
                                            @error="$event.target.src='assets/images/placeholder.png'" />
                                        <div class="card-info">
                                            <div class="card-name">{{ card.name }}</div>
                                            <div class="card-type">{{ card.type_line }}</div>
                                            <div class="card-cost" v-if="card.mana_cost">{{ card.mana_cost }}</div>
                                        </div>
                                    </div>
                                </div>

                                <div v-if="!searchLoading && searchQuery && searchResults.length === 0"
                                    class="no-results">
                                    üòï Aucune carte trouv√©e pour "{{ searchQuery }}"
                                </div>
                            </div>

                            <!-- Ajout en bulk -->
                            <div class="bulk-add">
                                <h4>üìù Ajout en liste</h4>
                                <div class="form-group">
                                    <textarea v-model="bulkAddText"
                                        placeholder="Format : 4x Lightning Bolt&#10;2x Counterspell&#10;1x Black Lotus&#10;&#10;ou simplement :&#10;Lightning Bolt&#10;Counterspell"
                                        rows="8"></textarea>
                                </div>
                                <button @click="processBulkAdd" class="btn"
                                    :disabled="bulkLoading || !bulkAddText.trim()">
                                    {{ bulkLoading ? '‚è≥ Ajout en cours...' : 'üìã Ajouter les cartes' }}
                                </button>
                            </div>
                        </div>

                        <!-- Panel de droite: Liste du deck -->
                        <div class="editor-panel deck-panel">
                            <h3>üìö Liste du deck</h3>

                            <!-- Statistiques d√©taill√©es -->
                            <div class="deck-stats">
                                <div class="stat">
                                    <div class="stat-value">{{ getTotalCards() }}</div>
                                    <div class="stat-label">Total</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value">{{ getCreatureCount() }}</div>
                                    <div class="stat-label">Cr√©atures</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value">{{ getSpellCount() }}</div>
                                    <div class="stat-label">Sorts</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value">{{ getLandCount() }}</div>
                                    <div class="stat-label">Terrains</div>
                                </div>
                            </div>

                            <!-- Recommandations -->
                            <div v-if="deckRecommendations.length > 0" class="deck-recommendations">
                                <h4>üí° Recommandations</h4>
                                <div v-for="rec in deckRecommendations" :key="rec.message" class="recommendation"
                                    :class="rec.type">
                                    {{ rec.message }}
                                </div>
                            </div>

                            <!-- Loading des cartes du deck -->
                            <div v-if="deckLoading" class="loading">
                                ‚è≥ Chargement des cartes du deck...
                            </div>

                            <!-- Liste des cartes du deck - VERSION COMPACTE -->
                            <div class="deck-card-list">
                                <div v-for="{ cardId, quantity, card } in filteredDeckCards" :key="cardId"
                                    class="deck-card-entry-compact" @mouseenter="showCardImage($event, card)"
                                    @mouseleave="hideCardImage">
                                    <!-- Quantit√© -->
                                    <div class="card-quantity">
                                        <span class="quantity-display">{{ quantity }}</span>
                                    </div>

                                    <!-- Nom de la carte -->
                                    <div class="card-name-compact">
                                        {{ card.name }}
                                    </div>

                                    <!-- Contr√¥les discrets -->
                                    <div class="quantity-controls-compact">
                                        <button @click="removeCardFromDeck(cardId)" class="quantity-btn-compact"
                                            title="Retirer une carte">
                                            ‚àí
                                        </button>
                                        <button @click="addCardToDeckById(cardId)" class="quantity-btn-compact"
                                            title="Ajouter une carte">
                                            +
                                        </button>
                                    </div>
                                </div>

                                <!-- Message si deck vide -->
                                <div v-if="!deckLoading && filteredDeckCards.length === 0" class="empty-deck">
                                    <h4>üé¥ Votre deck est vide</h4>
                                    <p>Utilisez la recherche pour ajouter des cartes ou importez une liste existante !
                                    </p>
                                </div>
                            </div>

                            <!-- Tooltip pour l'image de carte -->
                            <div id="card-tooltip" class="card-tooltip">
                                <img id="card-tooltip-image" src="" alt="" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages globaux -->
                <div v-if="authError" class="error" @click="authError = ''">
                    {{ authError }}
                    <small style="display: block; margin-top: 0.5rem; opacity: 0.8;">
                        Cliquer pour fermer
                    </small>
                </div>
                <div v-if="authSuccess" class="success" @click="authSuccess = ''">
                    {{ authSuccess }}
                    <small style="display: block; margin-top: 0.5rem; opacity: 0.8;">
                        Cliquer pour fermer
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts - ORDRE CRITIQUE - NE PAS MODIFIER -->
    <!-- 1. Utilitaires (sans d√©pendances) -->
    <script src="assets/js/utils/helpers.js"></script>
    <script src="assets/js/utils/cache.js"></script>

    <!-- 2. Configuration (d√©pend des utilitaires) -->
    <script src="assets/js/config/supabase.js"></script>

    <!-- 3. Services (d√©pendent de config et utilitaires) -->
    <script src="assets/js/services/scryfall.service.js"></script>
    <script src="assets/js/services/auth.service.js"></script>
    <script src="assets/js/services/deck.service.js"></script>

    <!-- 4. Store (d√©pend de tous les services) -->
    <script src="assets/js/store/store.js"></script>

    <!-- 5. Application principale (d√©pend du store) -->
    <script src="assets/js/app.js"></script>
</body>

</html>