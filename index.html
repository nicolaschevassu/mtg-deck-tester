<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Deck Builder</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>
    <div class="header">
        <h1>üé¥ MTG Deck Builder</h1>
        <p>Cr√©ez et testez vos decks Magic The Gathering</p>
    </div>

    <div id="app">
        <div class="container">
            <!-- Debug temporaire -->
            <div style="background: #fff3cd; color: #856404; padding: 15px; margin: 10px 0; border-radius: 5px;">
                <strong>DEBUG:</strong>
                supabaseConfigured: {{ supabaseConfigured }} |
                isConnected: {{ isConnected }} |
                isAuthenticated: {{ isAuthenticated }}
            </div>

            <!-- 1. CONFIGURATION SUPABASE (niveau racine) -->
            <div v-if="!supabaseConfigured" class="config-form">
                <h2>Configuration Supabase</h2>
                <div class="config-notice">
                    <strong>Configuration requise :</strong> Veuillez configurer votre projet Supabase pour commencer.
                </div>

                <div class="form-group">
                    <label for="supabase-url">URL du projet Supabase :</label>
                    <input type="url" id="supabase-url" v-model="supabaseConfig.url"
                        placeholder="https://votre-projet.supabase.co" />
                </div>
                <div class="form-group">
                    <label for="supabase-key">Cl√© publique (anon key) :</label>
                    <input type="text" id="supabase-key" v-model="supabaseConfig.anonKey"
                        placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." />
                </div>
                <button @click="configureSupabase" class="btn"
                    :disabled="!supabaseConfig.url || !supabaseConfig.anonKey">
                    Se connecter √† Supabase
                </button>

                <div style="margin-top: 30px;">
                    <h3>Instructions de configuration :</h3>
                    <ol style="margin-left: 20px; line-height: 1.6;">
                        <li>Cr√©ez un compte sur <a href="https://supabase.com" target="_blank">supabase.com</a></li>
                        <li>Cr√©ez un nouveau projet</li>
                        <li>Allez dans Settings ‚Üí API</li>
                        <li>Copiez l'URL du projet et la cl√© "anon/public"</li>
                        <li>Cr√©ez la table "decks" avec ce SQL :</li>
                    </ol>
                    <div class="code-block">
                        CREATE TABLE decks (
                        id BIGSERIAL PRIMARY KEY,
                        user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
                        name TEXT NOT NULL,
                        cards JSONB DEFAULT '{}',
                        created_at TIMESTAMPTZ DEFAULT NOW(),
                        updated_at TIMESTAMPTZ DEFAULT NOW()
                        );

                        -- Activer RLS (Row Level Security)
                        ALTER TABLE decks ENABLE ROW LEVEL SECURITY;

                        -- Politique pour que les utilisateurs ne voient que leurs decks
                        CREATE POLICY "Users can view own decks" ON decks
                        FOR SELECT USING (auth.uid() = user_id);

                        CREATE POLICY "Users can insert own decks" ON decks
                        FOR INSERT WITH CHECK (auth.uid() = user_id);

                        CREATE POLICY "Users can update own decks" ON decks
                        FOR UPDATE USING (auth.uid() = user_id);

                        CREATE POLICY "Users can delete own decks" ON decks
                        FOR DELETE USING (auth.uid() = user_id);
                    </div>
                </div>
            </div>

            <!-- 2. STATUT DE CONNEXION (niveau racine) -->
            <div v-if="supabaseConfigured" class="connection-status"
                :class="{ connected: isConnected, disconnected: !isConnected }">
                {{ isConnected ? '‚úÖ Connect√© √† Supabase' : '‚ùå Connexion √† Supabase √©chou√©e' }}
            </div>

            <!-- 3. AUTHENTIFICATION (niveau racine) -->
            <div v-if="supabaseConfigured && !isAuthenticated" class="auth-container">
                <div class="tab-buttons">
                    <button class="tab-button" :class="{ active: authMode === 'login' }" @click="authMode = 'login'">
                        Connexion
                    </button>
                    <button class="tab-button" :class="{ active: authMode === 'register' }"
                        @click="authMode = 'register'">
                        Inscription
                    </button>
                </div>

                <!-- Formulaire de connexion -->
                <form v-if="authMode === 'login'" @submit.prevent="login">
                    <div class="form-group">
                        <label for="email">Email :</label>
                        <input type="email" id="email" v-model="loginForm.email" required
                            placeholder="votre@email.com" />
                    </div>
                    <div class="form-group">
                        <label for="password">Mot de passe :</label>
                        <input type="password" id="password" v-model="loginForm.password" required
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                    </div>
                    <button type="submit" class="btn" :disabled="authLoading">
                        {{ authLoading ? 'Connexion...' : 'Se connecter' }}
                    </button>
                </form>

                <!-- Formulaire d'inscription -->
                <form v-if="authMode === 'register'" @submit.prevent="register">
                    <div class="form-group">
                        <label for="reg-email">Email :</label>
                        <input type="email" id="reg-email" v-model="registerForm.email" required
                            placeholder="votre@email.com" />
                    </div>
                    <div class="form-group">
                        <label for="reg-password">Mot de passe :</label>
                        <input type="password" id="reg-password" v-model="registerForm.password" required
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6" />
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">Confirmer le mot de passe :</label>
                        <input type="password" id="confirm-password" v-model="registerForm.confirmPassword" required
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                    </div>
                    <button type="submit" class="btn" :disabled="authLoading">
                        {{ authLoading ? 'Inscription...' : 'S\'inscrire' }}
                    </button>
                </form>

                <div v-if="authError" class="error">
                    {{ authError }}
                </div>
                <div v-if="authSuccess" class="success">
                    {{ authSuccess }}
                </div>
            </div>

            <!-- 4. APPLICATION PRINCIPALE (niveau racine) -->
            <div v-if="supabaseConfigured && isAuthenticated" class="app-container">
                <div class="user-info">
                    <div>
                        <strong>Bienvenue, {{ currentUser?.email }} !</strong>
                    </div>
                    <button @click="logout" class="btn btn-secondary">D√©connexion</button>
                </div>

                <!-- Liste des decks -->
                <div v-if="currentView === 'decks'">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Mes Decks</h2>
                        <button @click="showCreateDeck = true" class="btn">+ Nouveau Deck</button>
                    </div>

                    <!-- Formulaire de cr√©ation de deck -->
                    <div v-if="showCreateDeck"
                        style="margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h3>Cr√©er un nouveau deck</h3>
                        <div class="form-group">
                            <label for="deck-name">Nom du deck :</label>
                            <input type="text" id="deck-name" v-model="newDeckName" placeholder="Mon super deck" />
                        </div>
                        <button @click="createDeck" class="btn" :disabled="!newDeckName.trim() || deckLoading">
                            {{ deckLoading ? 'Cr√©ation...' : 'Cr√©er' }}
                        </button>
                        <button @click="showCreateDeck = false" class="btn btn-secondary">Annuler</button>
                    </div>

                    <div v-if="decksLoading" class="loading">
                        Chargement des decks...
                    </div>

                    <div class="deck-list">
                        <div v-for="deck in userDecks" :key="deck.id" class="deck-card" @click="openDeck(deck)">
                            <h3>{{ deck.name }}</h3>
                            <p>{{ getTotalCardsFromDeckData(deck.cards) }} cartes</p>
                            <p style="color: #666; font-size: 14px;">
                                Cr√©√© le {{ formatDate(deck.created_at) }}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- √âditeur de deck -->
                <div v-if="currentView === 'deck-editor' && currentDeck">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>{{ currentDeck.name }}</h2>
                        <div>
                            <button @click="saveDeck" class="btn" :disabled="deckLoading">
                                {{ deckLoading ? 'Sauvegarde...' : 'Sauvegarder' }}
                            </button>
                            <button @click="goBackToDecks" class="btn btn-secondary">Retour</button>
                        </div>
                    </div>

                    <div class="deck-editor">
                        <div>
                            <!-- Recherche de cartes -->
                            <div class="card-search">
                                <h3>Recherche de cartes</h3>
                                <div class="form-group">
                                    <input type="text" v-model="searchQuery" @input="searchCards"
                                        placeholder="Rechercher une carte..." />
                                </div>

                                <div v-if="searchLoading" class="loading">
                                    Recherche en cours...
                                </div>

                                <div v-if="searchResults.length > 0" class="search-results">
                                    <div v-for="card in searchResults" :key="card.id" class="card-result"
                                        @click="addCardToDeck(card)">
                                        <img :src="card.image_uris?.small || '/api/placeholder/50/70'" :alt="card.name"
                                            class="card-image" @error="$event.target.src='/api/placeholder/50/70'" />
                                        <div class="card-info">
                                            <div class="card-name">{{ card.name }}</div>
                                            <div class="card-type">{{ card.type_line }}</div>
                                            <div style="font-size: 12px; color: #888;">
                                                {{ card.mana_cost }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Ajout en bulk -->
                            <div class="bulk-add">
                                <h3>Ajout en liste</h3>
                                <div class="form-group">
                                    <textarea v-model="bulkAddText"
                                        placeholder="Format: 4x Lightning Bolt&#10;2x Counterspell&#10;1x Black Lotus"></textarea>
                                </div>
                                <button @click="processBulkAdd" class="btn" :disabled="bulkLoading">
                                    {{ bulkLoading ? 'Ajout en cours...' : 'Ajouter les cartes' }}
                                </button>
                            </div>
                        </div>

                        <div class="deck-list-display">
                            <h3>Liste du deck</h3>

                            <!-- Statistiques -->
                            <div class="deck-stats">
                                <div class="stat">
                                    <div class="stat-value">{{ getTotalCards() }}</div>
                                    <div class="stat-label">Total</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value">{{ getCreatureCount() }}</div>
                                    <div class="stat-label">Cr√©atures</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value">{{ getSpellCount() }}</div>
                                    <div class="stat-label">Sorts</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value">{{ getLandCount() }}</div>
                                    <div class="stat-label">Terrains</div>
                                </div>
                            </div>

                            <!-- Liste des cartes -->
                            <div v-for="(quantity, cardId) in currentDeck.cards" :key="cardId">
                                <div v-if="getCardById(cardId)" class="deck-card-entry">
                                    <div>
                                        <strong>{{ quantity }}x</strong> {{ getCardById(cardId).name }}
                                        <div style="font-size: 12px; color: #666;">
                                            {{ getCardById(cardId).type_line }}
                                        </div>
                                    </div>
                                    <div class="quantity-controls">
                                        <button @click="removeCardFromDeck(cardId)" class="quantity-btn">-</button>
                                        <span>{{ quantity }}</span>
                                        <button @click="addCardToDeckById(cardId)" class="quantity-btn">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/app.js"></script>
</body>

</html>