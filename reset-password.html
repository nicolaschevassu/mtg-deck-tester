<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©initialisation du mot de passe - MTG Deck Builder</title>

    <!-- CDN externes -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>
    <!-- Header -->
    <div class="header">
        <h1>üé¥ Helltrip MTG Tester</h1>
    </div>

    <!-- Application Vue.js -->
    <div id="reset-app">
        <div class="container">
            <!-- Loading global -->
            <div v-if="loading" class="loading-overlay">
                <div class="spinner"></div>
                <p>Chargement...</p>
            </div>

            <!-- Configuration Supabase -->
            <div v-if="!loading && !supabaseConfigured" class="config-form">
                <h2>‚öôÔ∏è Configuration Supabase</h2>
                <div class="config-notice">
                    <strong>Configuration requise :</strong> Veuillez configurer votre projet Supabase.
                </div>

                <div class="form-group">
                    <label for="supabase-url">URL du projet Supabase :</label>
                    <input type="url" id="supabase-url" v-model="supabaseConfig.url"
                        placeholder="https://votre-projet.supabase.co" />
                </div>
                <div class="form-group">
                    <label for="supabase-key">Cl√© publique (anon key) :</label>
                    <input type="text" id="supabase-key" v-model="supabaseConfig.anonKey"
                        placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." />
                </div>
                <button @click="configureSupabase" class="btn"
                    :disabled="authLoading || !supabaseConfig.url || !supabaseConfig.anonKey">
                    {{ authLoading ? 'Connexion en cours...' : 'Se connecter √† Supabase' }}
                </button>
            </div>

            <!-- Formulaire de r√©initialisation -->
            <div v-if="!loading && supabaseConfigured" class="auth-container">
                <h2 style="text-align: center; margin-bottom: 1.5rem; color: var(--primary-color);">
                    üîê Nouveau mot de passe
                </h2>

                <form @submit.prevent="updatePassword" v-if="!passwordUpdated">
                    <div class="form-group">
                        <label for="new-password">Nouveau mot de passe (minimum 6 caract√®res) :</label>
                        <input type="password" id="new-password" v-model="newPassword" required
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6" />
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">Confirmer le nouveau mot de passe :</label>
                        <input type="password" id="confirm-password" v-model="confirmPassword" required
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                    </div>
                    <button type="submit" class="btn" :disabled="authLoading">
                        {{ authLoading ? 'Mise √† jour...' : 'Mettre √† jour le mot de passe' }}
                    </button>
                </form>

                <!-- Succ√®s -->
                <div v-if="passwordUpdated" class="success">
                    <h3>‚úÖ Mot de passe mis √† jour avec succ√®s !</h3>
                    <p>Votre mot de passe a √©t√© chang√©. Vous pouvez maintenant retourner √† l'application.</p>
                    <a href="index.html" class="btn">Retour √† l'application</a>
                </div>

                <!-- Messages d'erreur et de succ√®s -->
                <div v-if="error" class="error">
                    {{ error }}
                </div>
                <div v-if="success" class="success">
                    {{ success }}
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    loading: true,
                    supabaseConfigured: false,
                    authLoading: false,
                    error: '',
                    success: '',
                    newPassword: '',
                    confirmPassword: '',
                    passwordUpdated: false,
                    supabaseClient: null,
                    supabaseConfig: {
                        url: '',
                        anonKey: ''
                    }
                };
            },

            async mounted() {
                try {
                    // Tenter de charger la configuration Supabase sauv√©e
                    const savedConfig = this.loadSavedConfig();

                    if (savedConfig) {
                        this.supabaseConfig = savedConfig;
                        await this.initializeSupabase();
                    }
                } catch (error) {
                    console.error('Erreur lors du chargement:', error);
                    this.error = 'Erreur lors de l\'initialisation';
                } finally {
                    this.loading = false;
                }
            },

            methods: {
                loadSavedConfig() {
                    try {
                        const saved = localStorage.getItem('supabase_config');
                        return saved ? JSON.parse(saved) : null;
                    } catch (error) {
                        console.error('Erreur lors du chargement de la config:', error);
                        return null;
                    }
                },

                async configureSupabase() {
                    try {
                        this.authLoading = true;
                        this.error = '';

                        // Sauvegarder la config
                        localStorage.setItem('supabase_config', JSON.stringify(this.supabaseConfig));

                        await this.initializeSupabase();
                    } catch (error) {
                        this.error = `Erreur de configuration: ${error.message}`;
                    } finally {
                        this.authLoading = false;
                    }
                },

                async initializeSupabase() {
                    this.supabaseClient = supabase.createClient(
                        this.supabaseConfig.url,
                        this.supabaseConfig.anonKey
                    );

                    this.supabaseConfigured = true;
                },

                async updatePassword() {
                    if (!this.newPassword || !this.confirmPassword) {
                        this.error = 'Tous les champs sont requis';
                        return;
                    }

                    if (this.newPassword !== this.confirmPassword) {
                        this.error = 'Les mots de passe ne correspondent pas';
                        return;
                    }

                    if (this.newPassword.length < 6) {
                        this.error = 'Le mot de passe doit contenir au moins 6 caract√®res';
                        return;
                    }

                    try {
                        this.authLoading = true;
                        this.error = '';

                        const { error } = await this.supabaseClient.auth.updateUser({
                            password: this.newPassword
                        });

                        if (error) throw error;

                        this.passwordUpdated = true;
                        this.success = 'Mot de passe mis √† jour avec succ√®s !';

                    } catch (error) {
                        this.error = `Erreur lors de la mise √† jour: ${error.message}`;
                    } finally {
                        this.authLoading = false;
                    }
                }
            }
        }).mount('#reset-app');
    </script>
</body>

</html>